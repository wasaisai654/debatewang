<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Debate Hub - 辩论资源共享平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入腾讯云开发 SDK -->
    <script src="https://res.wx.qq.com/open/js/cloudbase/1.1.0/cloud.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#FF7D00',
                        success: '#00B42A',
                        danger: '#F53F3F',
                        warning: '#FF9A2E'
                    }
                }
            }
        }
    </script>
    <style>
        .tab-content.active { display: block; }
        .tab-content { display: none; }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .comment-item {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 调试按钮（固定在右上角） -->
    <div class="fixed top-4 right-4 z-50 flex gap-2">
        <button onclick="showLoginModal()" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 text-sm shadow-lg">
            📺 显示登录弹窗
        </button>
        <button onclick="debugLogin()" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 text-sm shadow-lg">
            🔍 调试登录
        </button>
        <button onclick="debugRegister()" class="bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600 text-sm shadow-lg">
            🔍 调试注册
        </button>
        <button onclick="debugCloud()" class="bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600 text-sm shadow-lg">
            ☁️ 调试云存储
        </button>
    </div>
    
    <!-- 导航栏 -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="#" class="flex items-center space-x-2">
                        <div class="w-10 h-10 rounded-lg bg-primary flex items-center justify-center">
                            <i class="fa fa-balance-scale text-white"></i>
                        </div>
                        <span class="text-xl font-bold text-primary">Global Debate Hub</span>
                    </a>
                </div>
                
                <nav class="hidden md:flex space-x-8">
                    <button class="nav-tab text-primary font-medium border-b-2 border-primary py-5" data-tab="home">首页</button>
                    <button class="nav-tab text-gray-700 hover:text-primary font-medium py-5 hover:border-b-2 hover:border-primary transition-all" data-tab="resources">资源库</button>
                    <button class="nav-tab text-gray-700 hover:text-primary font-medium py-5 hover:border-b-2 hover:border-primary transition-all" data-tab="upload">上传资源</button>
                    <button class="nav-tab text-gray-700 hover:text-primary font-medium py-5 hover:border-b-2 hover:border-primary transition-all" data-tab="timer">辩论计时器</button>
                </nav>
                
                <div class="flex items-center space-x-4">
                    <div id="userMenu" class="flex items-center gap-3 hidden">
                        <span id="usernameDisplay" class="text-gray-700"></span>
                        <!-- 点击头像跳转个人中心 -->
                        <img src="https://picsum.photos/id/1005/100/100" alt="用户头像" class="w-8 h-8 rounded-full cursor-pointer nav-tab" data-tab="profile" id="navAvatar">
                        <button id="logoutBtn" class="text-gray-500 hover:text-primary">
                            <i class="fa fa-sign-out"></i>
                        </button>
                    </div>
                    
                    <div id="authButtons" class="flex items-center space-x-3">
                        <button id="loginBtn" class="px-4 py-2 text-primary border border-primary rounded-full hover:bg-primary/5">登录</button>
                        <button id="registerBtn" class="px-4 py-2 bg-primary text-white rounded-full hover:bg-primary/90">注册</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 py-8">
        <!-- 1. 首页标签 -->
        <div class="tab-content active" id="home-tab">
            <div class="bg-gradient-to-r from-primary/90 to-primary text-white rounded-2xl p-8 md:p-12 mb-8">
                <h1 class="text-3xl md:text-4xl font-bold mb-4">欢迎来到辩论资源共享平台</h1>
                <p class="text-white/90 mb-6 max-w-2xl">连接全球辩论爱好者，共享优质辩论资源，提升辩论技巧，参与精彩辩论赛事</p>
                <div class="flex flex-wrap gap-4">
                    <button class="px-6 py-3 bg-white text-primary font-semibold rounded-lg hover:bg-gray-100 transition-all nav-tab" data-tab="resources">
                        浏览资源库
                    </button>
                    <button class="px-6 py-3 bg-white/20 text-white font-semibold rounded-lg hover:bg-white/30 transition-all nav-tab" data-tab="timer">
                        使用辩论计时器
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-all">
                    <div class="w-12 h-12 rounded-lg bg-primary/10 flex items-center justify-center mb-4">
                        <i class="fa fa-book text-primary text-xl"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">丰富资源库</h3>
                    <p class="text-gray-600">海量辩论教程、赛事视频、辩题分析、技巧策略等资源供你学习</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-all">
                    <div class="w-12 h-12 rounded-lg bg-secondary/10 flex items-center justify-center mb-4">
                        <i class="fa fa-clock-o text-secondary text-xl"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">专业计时器</h3>
                    <p class="text-gray-600">辩论专用计时器，支持倒计时和正计时，精准控制发言时间</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-all">
                    <div class="w-12 h-12 rounded-lg bg-success/10 flex items-center justify-center mb-4">
                        <i class="fa fa-upload text-success text-xl"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">资源共享</h3>
                    <p class="text-gray-600">上传你的优质辩论资源，与全球辩论爱好者共同交流进步</p>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <h2 class="text-2xl font-bold mb-6">热门资源推荐</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="featuredResources">
                    <!-- 热门资源动态生成 -->
                </div>
            </div>
        </div>

        <!-- 2. 资源库标签 -->
        <div class="tab-content hidden" id="resources-tab">
            <div class="flex items-center gap-2 mb-6">
                <span class="text-gray-700 font-medium">资源库</span>
            </div>
            
            <h1 class="text-3xl font-bold mb-6">辩论资源库</h1>
            
            <!-- 高级搜索和筛选区 -->
            <div class="bg-white p-6 rounded-xl shadow-sm mb-8">
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <div class="relative flex-1">
                        <input type="text" id="resourceSearch" placeholder="搜索资源标题、描述、上传者..." class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                        <i class="fa fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    
                    <div class="flex flex-wrap gap-3">
                        <select id="categoryFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                            <option value="">所有分类</option>
                            <option value="tutorial">辩论教程</option>
                            <option value="video">赛事视频</option>
                            <option value="analysis">辩题分析</option>
                            <option value="strategy">技巧策略</option>
                        </select>
                        
                        <!-- 新增：高级筛选 -->
                        <select id="sortFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                            <option value="">默认排序</option>
                            <option value="downloadDesc">下载量从高到低</option>
                            <option value="downloadAsc">下载量从低到高</option>
                            <option value="timeNew">最新上传</option>
                            <option value="timeOld">最早上传</option>
                        </select>
                        
                        <input type="text" id="uploaderFilter" placeholder="按上传者筛选" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                    </div>
                </div>
                
                <!-- 新增：高级筛选扩展 -->
                <div class="flex flex-wrap gap-3">
                    <div class="flex items-center gap-2">
                        <label class="text-gray-700 text-sm">文件大小：</label>
                        <select id="sizeFilter" class="px-3 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-sm">
                            <option value="">不限</option>
                            <option value="small">小于10MB</option>
                            <option value="medium">10-50MB</option>
                            <option value="large">大于50MB</option>
                        </select>
                    </div>
                    
                    <button id="advancedSearchBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 text-sm">
                        <i class="fa fa-filter mr-1"></i> 应用筛选
                    </button>
                    <button id="resetSearchBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm">
                        <i class="fa fa-refresh mr-1"></i> 重置筛选
                    </button>
                </div>
            </div>
            
            <!-- 资源列表 -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="resourcesList">
                <!-- 资源列表动态生成 -->
            </div>
        </div>

        <!-- 3. 上传资源标签 -->
        <div class="tab-content hidden" id="upload-tab">
            <div class="flex items-center gap-2 mb-6">
                <span class="text-gray-700 font-medium">上传资源</span>
            </div>
            
            <h1 class="text-3xl font-bold mb-6">上传新资源</h1>
            
            <!-- 未登录提示 -->
            <div id="uploadNotLoggedIn" class="bg-white rounded-xl shadow-sm p-8 max-w-3xl mx-auto">
                <div class="text-center">
                    <i class="fa fa-exclamation-circle text-4xl text-yellow-500 mb-4"></i>
                    <h3 class="text-xl font-bold mb-2">请先登录</h3>
                    <p class="text-gray-600 mb-6">登录后才能上传资源，登录后您的资源将保存在个人中心</p>
                    <button class="px-6 py-2 bg-primary text-white rounded-full hover:bg-primary/90 transition-all" id="uploadLoginBtn">
                        立即登录
                    </button>
                </div>
            </div>
            
            <!-- 上传表单 -->
            <div id="uploadFormContainer" class="bg-white rounded-xl shadow-sm p-6 max-w-3xl mx-auto hidden">
                <form id="uploadForm">
                    <div class="mb-6">
                        <label for="resourceTitle" class="block text-gray-700 font-medium mb-2">资源标题 <span class="text-red-500">*</span></label>
                        <input type="text" id="resourceTitle" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="请输入资源标题" required>
                    </div>
                    
                    <div class="mb-6">
                        <label for="resourceCategory" class="block text-gray-700 font-medium mb-2">资源分类 <span class="text-red-500">*</span></label>
                        <select id="resourceCategory" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" required>
                            <option value="">请选择分类</option>
                            <option value="tutorial">辩论教程</option>
                            <option value="video">赛事视频</option>
                            <option value="analysis">辩题分析</option>
                            <option value="strategy">技巧策略</option>
                        </select>
                    </div>
                    
                    <div class="mb-6">
                        <label for="resourceDescription" class="block text-gray-700 font-medium mb-2">资源描述</label>
                        <textarea id="resourceDescription" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="请简要描述资源内容和特点"></textarea>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-gray-700 font-medium mb-2">上传文件 <span class="text-red-500">*</span></label>
                        <div id="fileUploadArea" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-primary transition-all">
                            <i class="fa fa-cloud-upload text-4xl text-gray-400 mb-3"></i>
                            <p class="text-gray-600 mb-2">点击或拖拽文件到此处上传</p>
                            <p class="text-gray-400 text-sm">支持 PDF, DOC, DOCX, MP4 等格式，最大50MB</p>
                            <input type="file" id="fileInput" class="hidden" required>
                        </div>
                        <div id="filePreview" class="mt-4 hidden">
                            <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                <i class="fa fa-file-text-o text-primary text-xl"></i>
                                <div class="flex-1">
                                    <p id="fileName" class="font-medium text-gray-800"></p>
                                    <p id="fileSize" class="text-xs text-gray-500"></p>
                                </div>
                                <button type="button" id="removeFile" class="text-gray-400 hover:text-red-500">
                                    <i class="fa fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="termsAgreement" class="w-4 h-4 text-primary" required>
                            <span class="text-gray-700 text-sm">我确认此资源为本人原创或已获得授权，不侵犯任何第三方权益</span>
                        </label>
                    </div>
                    
                    <button type="submit" class="w-full py-3 bg-primary text-white font-semibold rounded-lg hover:bg-primary/90 transition-all">
                        提交上传
                    </button>
                </form>
            </div>
        </div>

        <!-- 4. 辩论计时器标签 -->
        <div class="tab-content hidden" id="timer-tab">
            <div class="flex items-center gap-2 mb-6">
                <span class="text-gray-700 font-medium">辩论计时器</span>
            </div>
            
            <div class="max-w-md w-full bg-white rounded-2xl shadow-lg overflow-hidden mx-auto">
                <!-- 标题区域 -->
                <div class="bg-primary text-white p-6 text-center">
                    <h1 class="text-2xl font-bold">辩论计时器</h1>
                    <p class="text-white/80 mt-1">精确控制辩论时间</p>
                </div>
                
                <!-- 计时器显示区域 -->
                <div class="p-8">
                    <div class="text-center mb-8">
                        <div id="timer-display" class="text-6xl font-bold text-gray-800">00:05:00</div>
                        <div id="timer-status" class="text-gray-500 mt-2">准备就绪</div>
                    </div>
                    
                    <!-- 时间设置区域 -->
                    <div class="grid grid-cols-3 gap-4 mb-8">
                        <div class="text-center">
                            <label for="hours" class="block text-sm text-gray-600 mb-1">小时</label>
                            <input type="number" id="hours" min="0" max="23" value="0" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-primary focus:border-primary">
                        </div>
                        <div class="text-center">
                            <label for="minutes" class="block text-sm text-gray-600 mb-1">分钟</label>
                            <input type="number" id="minutes" min="0" max="59" value="5" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-primary focus:border-primary">
                        </div>
                        <div class="text-center">
                            <label for="seconds" class="block text-sm text-gray-600 mb-1">秒钟</label>
                            <input type="number" id="seconds" min="0" max="59" value="0" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-primary focus:border-primary">
                        </div>
                    </div>
                    
                    <!-- 计时器模式切换 -->
                    <div class="flex justify-center gap-4 mb-8">
                        <button id="countdown-mode" class="px-4 py-2 bg-primary text-white rounded-full text-sm font-medium">
                            倒计时模式
                        </button>
                        <button id="stopwatch-mode" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-sm font-medium hover:bg-gray-300">
                            正计时模式
                        </button>
                    </div>
                    
                    <!-- 控制按钮区域 -->
                    <div class="flex justify-center gap-4">
                        <button id="start-btn" class="px-6 py-3 bg-success text-white rounded-lg hover:bg-success/90 transition-all flex items-center gap-2">
                            <i class="fa fa-play"></i> 开始
                        </button>
                        <button id="pause-btn" class="px-6 py-3 bg-secondary text-white rounded-lg hover:bg-secondary/90 transition-all flex items-center gap-2 hidden">
                            <i class="fa fa-pause"></i> 暂停
                        </button>
                        <button id="reset-btn" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all flex items-center gap-2">
                            <i class="fa fa-refresh"></i> 重置
                        </button>
                    </div>
                </div>
                
                <!-- 预设时间区域 -->
                <div class="bg-gray-50 p-6 border-t border-gray-100">
                    <h3 class="text-gray-700 font-medium mb-4">常用预设</h3>
                    <div class="flex flex-wrap gap-3">
                        <button class="preset-time px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm hover:bg-gray-300" data-minutes="1">1分钟</button>
                        <button class="preset-time px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm hover:bg-gray-300" data-minutes="3">3分钟</button>
                        <button class="preset-time px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm hover:bg-gray-300" data-minutes="5">5分钟</button>
                        <button class="preset-time px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm hover:bg-gray-300" data-minutes="7">7分钟</button>
                        <button class="preset-time px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm hover:bg-gray-300" data-minutes="10">10分钟</button>
                        <button class="preset-time px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm hover:bg-gray-300" data-minutes="15">15分钟</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. 新增：个人中心标签 -->
        <div class="tab-content hidden" id="profile-tab">
            <div class="flex items-center gap-2 mb-6">
                <span class="text-gray-700 font-medium">个人中心</span>
            </div>
            
            <h1 class="text-3xl font-bold mb-6">个人中心</h1>
            
            <!-- 未登录提示 -->
            <div id="profileNotLoggedIn" class="bg-white rounded-xl shadow-sm p-8 max-w-3xl mx-auto">
                <div class="text-center">
                    <i class="fa fa-exclamation-circle text-4xl text-yellow-500 mb-4"></i>
                    <h3 class="text-xl font-bold mb-2">请先登录</h3>
                    <p class="text-gray-600 mb-6">登录后才能查看个人中心内容</p>
                    <button class="px-6 py-2 bg-primary text-white rounded-full hover:bg-primary/90 transition-all" id="profileLoginBtn">
                        立即登录
                    </button>
                </div>
            </div>
            
            <!-- 个人中心内容 -->
            <div id="profileContent" class="hidden">
                <!-- 个人信息卡片 -->
                <div class="bg-white rounded-xl shadow-sm p-6 mb-8 max-w-3xl mx-auto">
                    <div class="flex items-center gap-4 mb-6">
                        <img src="https://picsum.photos/id/1005/100/100" alt="用户头像" class="w-16 h-16 rounded-full">
                        <div>
                            <h2 class="text-xl font-bold" id="profileUsername"></h2>
                            <p class="text-gray-500 text-sm">加入时间：<span id="profileJoinTime"></span></p>
                        </div>
                    </div>
                    
                    <!-- 个人数据统计 -->
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-bold text-primary" id="profileUploadCount">0</div>
                            <div class="text-gray-600 text-sm">上传资源</div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-bold text-secondary" id="profileCollectCount">0</div>
                            <div class="text-gray-600 text-sm">收藏资源</div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-bold text-success" id="profileDownloadCount">0</div>
                            <div class="text-gray-600 text-sm">下载资源</div>
                        </div>
                    </div>
                </div>
                
                <!-- 个人中心标签切换 -->
                <div class="flex border-b border-gray-200 mb-6 max-w-3xl mx-auto">
                    <button class="profile-subtab px-6 py-3 font-medium text-primary border-b-2 border-primary" data-subtab="myUploads">我的上传</button>
                    <button class="profile-subtab px-6 py-3 font-medium text-gray-500 hover:text-primary" data-subtab="myCollections">我的收藏</button>
                    <button class="profile-subtab px-6 py-3 font-medium text-gray-500 hover:text-primary" data-subtab="myInfo">个人信息</button>
                </div>
                
                <!-- 我的上传 -->
                <div class="profile-subcontent active" id="myUploads-tab">
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-8 max-w-3xl mx-auto">
                        <h3 class="text-lg font-bold mb-4">我上传的资源</h3>
                        <div id="myUploadsList" class="space-y-4">
                            <!-- 我的上传资源列表 -->
                            <div class="text-center text-gray-500 py-8" id="myUploadsEmpty">
                                <i class="fa fa-cloud-upload text-4xl mb-2"></i>
                                <p>你还没有上传任何资源</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 我的收藏 -->
                <div class="profile-subcontent hidden" id="myCollections-tab">
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-8 max-w-3xl mx-auto">
                        <h3 class="text-lg font-bold mb-4">我收藏的资源</h3>
                        <div id="myCollectionsList" class="space-y-4">
                            <!-- 我的收藏资源列表 -->
                            <div class="text-center text-gray-500 py-8" id="myCollectionsEmpty">
                                <i class="fa fa-star-o text-4xl mb-2"></i>
                                <p>你还没有收藏任何资源</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 个人信息 -->
                <div class="profile-subcontent hidden" id="myInfo-tab">
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-8 max-w-3xl mx-auto">
                        <h3 class="text-lg font-bold mb-4">修改个人信息</h3>
                        <form id="profileForm">
                            <div class="mb-6">
                                <label for="profileNewUsername" class="block text-gray-700 font-medium mb-2">用户名</label>
                                <input type="text" id="profileNewUsername" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                            </div>
                            
                            <div class="mb-6">
                                <label for="profileNewPassword" class="block text-gray-700 font-medium mb-2">新密码</label>
                                <input type="password" id="profileNewPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="留空则不修改">
                            </div>
                            
                            <div class="mb-6">
                                <label for="profileConfirmPassword" class="block text-gray-700 font-medium mb-2">确认新密码</label>
                                <input type="password" id="profileConfirmPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="留空则不修改">
                            </div>
                            
                            <button type="submit" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all">
                                保存修改
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 6. 登录/注册模态框 -->
        <div id="authModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
            <div class="bg-white rounded-xl shadow-lg max-w-md w-full m-4">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold" id="authModalTitle">用户登录</h2>
                        <button id="closeAuthModal" class="text-gray-400 hover:text-gray-600">
                            <i class="fa fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <!-- 登录表单 -->
                    <div id="authLoginForm">
                        <div class="mb-6">
                            <label for="loginUsername" class="block text-gray-700 font-medium mb-2">用户名</label>
                            <input type="text" id="loginUsername" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="请输入用户名" required>
                        </div>
                        
                        <div class="mb-6">
                            <label for="loginPassword" class="block text-gray-700 font-medium mb-2">密码</label>
                            <input type="password" id="loginPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="请输入密码" required>
                        </div>
                        
                        <div class="flex justify-between items-center mb-6">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="w-4 h-4 text-primary">
                                <span class="text-gray-600 text-sm">记住我</span>
                            </label>
                            <a href="#" class="text-primary hover:text-primary/80 text-sm">忘记密码？</a>
                        </div>
                        
                        <button type="button" id="doLoginBtn" class="w-full py-3 bg-primary text-white font-semibold rounded-lg hover:bg-primary/90 transition-all mb-4">
                            登录
                        </button>
                        
                        <div class="text-center text-gray-600 text-sm">
                            还没有账号？ <a href="#" class="text-primary hover:text-primary/80" id="switchToRegister">立即注册</a>
                        </div>
                        
                        <!-- 调试按钮（临时添加） -->
                        <div class="mt-4">
                            <button onclick="debugLogin()" class="text-xs text-gray-500 hover:text-gray-700">🔍 调试登录</button>
                            <button onclick="debugRegister()" class="text-xs text-gray-500 hover:text-gray-700 ml-2">🔍 调试注册</button>
                            <button onclick="debugCloud()" class="text-xs text-gray-500 hover:text-gray-700 ml-2">☁️ 调试云存储</button>
                            <button onclick="showLoginModal()" class="text-xs text-gray-500 hover:text-gray-700 ml-2">📺 显示登录弹窗</button>
                            <button onclick="console.log('🔍 页面状态:', document.readyState)" class="text-xs text-gray-500 hover:text-gray-700 ml-2">📊 页面状态</button>
                        </div>
                    </div>
                    
                    <!-- 注册表单 -->
                    <div id="authRegisterForm" class="hidden">
                        <div class="mb-6">
                            <label for="registerUsername" class="block text-gray-700 font-medium mb-2">用户名</label>
                            <input type="text" id="registerUsername" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="请设置用户名" required>
                        </div>
                        
                        <div class="mb-6">
                            <label for="registerPassword" class="block text-gray-700 font-medium mb-2">密码</label>
                            <input type="password" id="registerPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="请设置密码（至少6位）" required minlength="6">
                        </div>
                        
                        <div class="mb-6">
                            <label for="registerConfirmPassword" class="block text-gray-700 font-medium mb-2">确认密码</label>
                            <input type="password" id="registerConfirmPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="请再次输入密码" required>
                        </div>
                        
                        <div class="mb-6">
                            <label class="flex items-start gap-2">
                                <input type="checkbox" class="w-4 h-4 text-primary mt-1" required>
                                <span class="text-gray-600 text-sm">我已阅读并同意服务条款和隐私政策</span>
                            </label>
                        </div>
                        
                        <button type="button" id="doRegisterBtn" class="w-full py-3 bg-primary text-white font-semibold rounded-lg hover:bg-primary/90 transition-all mb-4">
                            注册
                        </button>
                        
                        <div class="text-center text-gray-600 text-sm">
                            已有账号？ <a href="#" class="text-primary hover:text-primary/80" id="switchToLogin">立即登录</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-gray-800 text-white pt-16 pb-8 mt-16">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-12">
                <div>
                    <div class="flex items-center space-x-2 mb-6">
                        <div class="w-10 h-10 rounded-lg bg-white flex items-center justify-center">
                            <i class="fa fa-balance-scale text-primary text-xl"></i>
                        </div>
                        <span class="text-xl font-bold">Global Debate Hub</span>
                    </div>
                    <p class="text-gray-400 mb-6">
                        连接全球辩论爱好者的知识共享平台，致力于推动辩论文化的发展和交流。
                    </p>
                </div>
            </div>
            
            <div class="border-t border-gray-700 pt-8">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <p class="text-gray-500 text-sm mb-4 md:mb-0">
                        © 2025 Global Debate Hub. 保留所有权利。
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- 消息提示框 -->
    <div id="toast" class="fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center gap-3 z-50">
        <i id="toastIcon" class="fa fa-check-circle text-xl"></i>
        <span id="toastMessage"></span>
    </div>

    <!-- 提示音元素 -->
    <audio id="warning-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" type="audio/mpeg">
    </audio>
    <audio id="complete-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3" type="audio/mpeg">
    </audio>

    <script>
        // 全局变量
        let currentResource = null;
        let timerInterval = null;
        let totalSeconds = 300; // 默认5分钟
        let remainingSeconds = totalSeconds;
        let isTimerRunning = false;
        let timerMode = 'countdown'; // 默认为倒计时模式
        let isCloudReady = false;
        
        // 云开发相关变量
        let app = null;
        let db = null;
        let storage = null;

        // ========== 配置项（云服务配置）=========
        // 1. Cloudinary 配置（文件上传）
        const CLOUDINARY_CLOUD_NAME = "dspkwgdxg";  // Cloudinary 云名称
        const CLOUDINARY_UPLOAD_PRESET = "debate_upload";  // Cloudinary 上传预设
        
        // 2. GitHub Gist 配置（数据同步）
        const GIST_ID = "66cb9500dec64469b901d640134dfb5f";  // GitHub Gist ID
        const GITHUB_TOKEN = "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";  // GitHub Token
        // ========================================
        
        console.log('☁️ 云服务配置已加载');
        console.log('📁 Cloudinary: ' + CLOUDINARY_CLOUD_NAME);
        console.log('🔄 GitHub Gist: ' + GIST_ID);
        
        // 初始化云存储
        async function initCloudBase() {
            try {
                console.log('📡 正在连接 GitHub Gist 云存储...');
                
                // 测试连接
                const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github+json'
                    }
                });
                
                if (response.ok) {
                    isCloudReady = true;
                    console.log('✅ GitHub Gist 云存储连接成功');
                    showToast('已连接到云服务', 'success');
                    
                    // 同步云数据到本地
                    console.log('🔄 同步云数据到本地...');
                    try {
                        const { users, resources } = await getCloudData();
                        console.log(`✅ 同步完成：${users.length}个用户，${resources.length}个资源`);
                        
                        // 如果云端有数据，更新本地
                        if (users.length > 0) {
                            localStorage.setItem('users', JSON.stringify(users));
                        }
                        if (resources.length > 0) {
                            localStorage.setItem('resources', JSON.stringify(resources));
                        }
                    } catch (syncError) {
                        console.error('❌ 数据同步失败:', syncError);
                    }
                    
                    return true;
                } else {
                    let errorMessage = `API错误: ${response.status} ${response.statusText}`;
                    if (response.status === 401) {
                        errorMessage = 'GitHub Token无效或权限不足';
                    } else if (response.status === 404) {
                        errorMessage = 'Gist不存在，请检查Gist ID';
                    } else if (response.status === 403) {
                        errorMessage = 'API访问受限';
                    }
                    console.error('❌ GitHub连接失败:', errorMessage);
                    showToast('云存储连接失败: ' + errorMessage, 'error');
                    isCloudReady = false;
                    return false;
                }
            } catch (error) {
                console.error('❌ 云存储初始化失败:', error);
                showToast('云存储初始化失败', 'error');
                isCloudReady = false;
                return false;
            }
        }
        
        // 直接从云存储获取数据
        async function getCloudData() {
            if (!isCloudReady) {
                console.warn('❌ 云存储未初始化');
                return { users: [], resources: [] };
            }
            
            try {
                const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github+json'
                    }
                });
                
                if (response.ok) {
                    const gist = await response.json();
                    const usersFile = gist.files['users.json'];
                    const resourcesFile = gist.files['resources.json'];
                    
                    const users = usersFile ? JSON.parse(usersFile.content) : [];
                    const resources = resourcesFile ? JSON.parse(resourcesFile.content) : [];
                    
                    console.log('✅ 成功从云存储获取数据');
                    return { users, resources };
                } else {
                    console.error('❌ 获取云存储数据失败:', response.status);
                    return { users: [], resources: [] };
                }
            } catch (error) {
                console.error('❌ 获取云存储数据出错:', error);
                return { users: [], resources: [] };
            }
        }
        
        // 直接保存数据到云存储
        async function saveCloudData(users, resources) {
            if (!isCloudReady) {
                console.warn('❌ 云存储未初始化');
                return false;
            }
            
            try {
                const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: {
                            'users.json': {
                                content: JSON.stringify(users)
                            },
                            'resources.json': {
                                content: JSON.stringify(resources)
                            }
                        }
                    })
                });
                
                if (response.ok) {
                    console.log('✅ 数据成功保存到云存储');
                    return true;
                } else {
                    console.error('❌ 保存数据到云存储失败:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('❌ 保存数据到云存储出错:', error);
                return false;
            }
        }

        // 显示提示框
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            
            // 设置提示框样式
            if (type === 'success') {
                toast.className = 'fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg transform translate-y-0 opacity-100 transition-all duration-300 flex items-center gap-3 z-50 bg-success/10 text-success';
                toastIcon.className = 'fa fa-check-circle text-xl';
            } else if (type === 'warning') {
                toast.className = 'fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg transform translate-y-0 opacity-100 transition-all duration-300 flex items-center gap-3 z-50 bg-warning/10 text-warning';
                toastIcon.className = 'fa fa-exclamation-triangle text-xl';
            } else if (type === 'error') {
                toast.className = 'fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg transform translate-y-0 opacity-100 transition-all duration-300 flex items-center gap-3 z-50 bg-danger/10 text-danger';
                toastIcon.className = 'fa fa-times-circle text-xl';
            }
            
            // 3秒后隐藏
            setTimeout(() => {
                toast.className = 'fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center gap-3 z-50';
            }, 3000);
        }

        // 格式化时间 秒 -> 时:分:秒
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        // 更新计时器显示
        function updateTimerDisplay() {
            const display = document.getElementById('timer-display');
            display.textContent = formatTime(remainingSeconds);
        }

        // 标签页切换函数
        function switchTab(tabId) {
            // 隐藏所有标签页
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
                tab.classList.add('hidden');
            });
            // 显示目标标签页
            const targetTab = document.getElementById(`${tabId}-tab`);
            if (targetTab) {
                targetTab.classList.add('active');
                targetTab.classList.remove('hidden');
            }
            // 更新导航栏样式
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('text-primary', 'border-b-2', 'border-primary');
                btn.classList.add('text-gray-700');
                if (btn.dataset.tab === tabId) {
                    btn.classList.add('text-primary', 'border-b-2', 'border-primary');
                    btn.classList.remove('text-gray-700');
                }
            });

            // 如果切换到个人中心，加载个人中心数据
            if (tabId === 'profile') {
                loadProfileData();
            }
        }

        // 个人中心子标签切换函数
        function switchProfileSubtab(subtabId) {
            // 隐藏所有子标签
            document.querySelectorAll('.profile-subcontent').forEach(subtab => {
                subtab.classList.remove('active');
                subtab.classList.add('hidden');
            });
            // 显示目标子标签
            const targetSubtab = document.getElementById(`${subtabId}-tab`);
            if (targetSubtab) {
                targetSubtab.classList.add('active');
                targetSubtab.classList.remove('hidden');
            }
            // 更新子标签样式
            document.querySelectorAll('.profile-subtab').forEach(btn => {
                btn.classList.remove('text-primary', 'border-b-2', 'border-primary');
                btn.classList.add('text-gray-500');
                if (btn.dataset.subtab === subtabId) {
                    btn.classList.add('text-primary', 'border-b-2', 'border-primary');
                    btn.classList.remove('text-gray-500');
                }
            });
        }

        // 初始化本地存储数据
        function initLocalStorage() {
            if (!localStorage.getItem('resources')) {
                const sampleResources = [
                    {
                        id: 'res_1',
                        title: '辩论入门：从逻辑到表达',
                        category: 'tutorial',
                        description: '适合新手的辩论基础教程，涵盖逻辑构建、论点表达、反驳技巧等核心内容。',
                        fileName: '辩论入门教程.pdf',
                        fileSize: 2048000,
                        uploader: '张明',
                        uploadTime: '2025-01-15',
                        downloadCount: 1200,
                        viewCount: 3500,
                        fileUrl: '#',
                        comments: [],
                        collectUsers: []
                    },
                    {
                        id: 'res_2',
                        title: '2024世界大学生辩论赛决赛',
                        category: 'video',
                        description: '哈佛大学与牛津大学的巅峰对决，辩题：人工智能的发展是否应受到严格限制。',
                        fileName: '2024辩论赛决赛.mp4',
                        fileSize: 45670000,
                        uploader: '国际辩论联盟',
                        uploadTime: '2025-02-20',
                        downloadCount: 5800,
                        viewCount: 12300,
                        fileUrl: '#',
                        comments: [],
                        collectUsers: []
                    }
                ];
                localStorage.setItem('resources', JSON.stringify(sampleResources));
            }
            
            if (!localStorage.getItem('users')) {
                localStorage.setItem('users', JSON.stringify([{
                    username: 'demo',
                    password: '123456',
                    joinTime: '2025-01-01',
                    downloadCount: 0
                }]));
            }
            
            if (!localStorage.getItem('collections')) {
                localStorage.setItem('collections', JSON.stringify([]));
            }
        }

        // 筛选资源
        function filterResources(resources) {
            const searchText = document.getElementById('resourceSearch').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const sortType = document.getElementById('sortFilter').value;
            const uploader = document.getElementById('uploaderFilter').value.toLowerCase();
            const sizeFilter = document.getElementById('sizeFilter').value;
            
            // 文本搜索筛选
            let filtered = resources.filter(resource => {
                const matchesSearch = resource.title.toLowerCase().includes(searchText) || 
                                     resource.description.toLowerCase().includes(searchText) ||
                                     resource.uploader.toLowerCase().includes(searchText);
                const matchesCategory = !category || resource.category === category;
                const matchesUploader = !uploader || resource.uploader.toLowerCase().includes(uploader);
                
                // 文件大小筛选
                let matchesSize = true;
                const fileSizeMB = resource.fileSize / 1024 / 1024;
                if (sizeFilter === 'small') matchesSize = fileSizeMB < 10;
                if (sizeFilter === 'medium') matchesSize = fileSizeMB >= 10 && fileSizeMB <= 50;
                if (sizeFilter === 'large') matchesSize = fileSizeMB > 50;
                
                return matchesSearch && matchesCategory && matchesUploader && matchesSize;
            });
            
            // 排序
            if (sortType === 'downloadDesc') {
                filtered = filtered.sort((a, b) => b.downloadCount - a.downloadCount);
            } else if (sortType === 'downloadAsc') {
                filtered = filtered.sort((a, b) => a.downloadCount - b.downloadCount);
            } else if (sortType === 'timeNew') {
                filtered = filtered.sort((a, b) => new Date(b.uploadTime) - new Date(a.uploadTime));
            } else if (sortType === 'timeOld') {
                filtered = filtered.sort((a, b) => new Date(a.uploadTime) - new Date(b.uploadTime));
            }
            
            return filtered;
        }

        // 加载资源列表
        async function loadResourcesList() {
            let resources = [];
            const resourcesList = document.getElementById('resourcesList');
            resourcesList.innerHTML = '';

            // 从云存储获取资源数据
            try {
                const { resources: cloudResources } = await getCloudData();
                resources = cloudResources;
                console.log('✅ 从云存储获取到', cloudResources.length, '个资源');
                
                // 同步到本地存储
                localStorage.setItem('resources', JSON.stringify(resources));
            } catch (error) {
                console.error('❌ 从云存储获取资源失败:', error);
                // 如果云存储失败，使用本地数据
                resources = JSON.parse(localStorage.getItem('resources') || '[]');
                console.log('⚠️ 使用本地存储的', resources.length, '个资源');
            }

            // 应用筛选
            resources = filterResources(resources);

            // 渲染资源列表
            const loggedUser = localStorage.getItem('loggedUser');
            resources.forEach((resource, index) => {
                const fileSize = (resource.fileSize / 1024 / 1024).toFixed(2) + 'MB';
                const categoryText = {
                    'tutorial': '辩论教程',
                    'video': '赛事视频',
                    'analysis': '辩题分析',
                    'strategy': '技巧策略'
                }[resource.category] || '其他';
                
                // 判断是否已收藏
                const isCollected = resource.collectUsers && resource.collectUsers.includes(loggedUser);
                const collectIcon = isCollected ? 'fa-star text-yellow-500' : 'fa-star-o text-gray-400';
                
                const resourceCard = `
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden hover:shadow-md transition-all cursor-pointer" data-index="${index}">
                        <div class="h-48 bg-gray-100 flex items-center justify-center relative">
                            <i class="fa fa-file-text-o text-5xl text-primary/50"></i>
                            <!-- 收藏按钮 -->
                            <button class="absolute top-4 right-4 w-8 h-8 rounded-full bg-white/80 flex items-center justify-center hover:bg-white collect-btn" data-index="${index}">
                                <i class="fa ${collectIcon}"></i>
                            </button>
                        </div>
                        <div class="p-5">
                            <span class="px-2 py-1 bg-primary/10 text-primary text-xs rounded-full">${categoryText}</span>
                            <h3 class="text-lg font-bold mt-3 mb-2">${resource.title}</h3>
                            <p class="text-gray-600 text-sm mb-4 line-clamp-2">${resource.description}</p>
                            <div class="flex justify-between items-center text-sm text-gray-500 mb-3">
                                <span>${resource.uploader}</span>
                                <span>${fileSize}</span>
                            </div>
                            <!-- 评论按钮 -->
                            <button class="text-primary text-sm flex items-center comment-toggle-btn" data-index="${index}">
                                <i class="fa fa-comment-o mr-1"></i> 评论(${resource.comments ? resource.comments.length : 0})
                            </button>
                            <!-- 评论区 -->
                            <div class="mt-4 hidden comment-section" data-index="${index}">
                                <div class="border-t border-gray-100 pt-3">
                                    <div class="flex gap-2 mb-3">
                                        <input type="text" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm comment-input" placeholder="发表你的评论..." data-index="${index}">
                                        <button class="px-3 py-2 bg-primary text-white rounded-lg text-sm comment-submit-btn" data-index="${index}">发布</button>
                                    </div>
                                    <div class="comment-list space-y-2 max-h-60 overflow-y-auto" data-index="${index}">
                                        <!-- 评论列表 -->
                                        ${resource.comments && resource.comments.length > 0 
                                            ? resource.comments.map(comment => `
                                                <div class="comment-item bg-gray-50 p-3 rounded-lg">
                                                    <div class="flex justify-between items-start">
                                                        <span class="font-medium text-sm">${comment.user}</span>
                                                        <span class="text-xs text-gray-400">${comment.time}</span>
                                                    </div>
                                                    <p class="text-sm mt-1">${comment.content}</p>
                                                </div>
                                            `).join('')
                                            : '<p class="text-gray-500 text-sm text-center py-2">暂无评论</p>'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                resourcesList.innerHTML += resourceCard;
            });

            // 加载热门资源
            document.getElementById('featuredResources').innerHTML = resourcesList.innerHTML;

            // 绑定资源卡片点击下载事件
            document.querySelectorAll('[data-index]').forEach(card => {
                // 排除按钮元素，避免事件冲突
                if (!card.classList.contains('collect-btn') && 
                    !card.classList.contains('comment-toggle-btn') &&
                    !card.classList.contains('comment-submit-btn')) {
                    card.addEventListener('click', async (e) => {
                        // 阻止事件冒泡
                        if (e.target.closest('.collect-btn') || e.target.closest('.comment-toggle-btn') || e.target.closest('.comment-submit-btn')) {
                            return;
                        }
                        
                        const index = parseInt(card.dataset.index);
                        const resource = resources[index];
                        
                        // 增加浏览次数
                        resource.viewCount = (resource.viewCount || 0) + 1;
                        localStorage.setItem('resources', JSON.stringify(resources));

                        // 下载文件（从 Cloudinary）
                        if (resource.fileUrl) {
                            // 打开新窗口下载
                            window.open(resource.fileUrl, '_blank');
                            
                            // 增加下载次数
                            resource.downloadCount = (resource.downloadCount || 0) + 1;
                            localStorage.setItem('resources', JSON.stringify(resources));
                            
                            // 更新用户下载次数
                            const loggedUser = localStorage.getItem('loggedUser');
                            if (loggedUser) {
                                const users = JSON.parse(localStorage.getItem('users') || '[]');
                                const userIndex = users.findIndex(u => u.username === loggedUser);
                                if (userIndex !== -1) {
                                    users[userIndex].downloadCount = (users[userIndex].downloadCount || 0) + 1;
                                    localStorage.setItem('users', JSON.stringify(users));
                                }
                            }
                            
                            showToast('开始下载资源');
                            
                            // 异步更新云存储（不阻塞用户操作）
                            (async () => {
                                try {
                                    const { users: cloudUsers, resources: cloudResources } = await getCloudData();
                                    const resourceIndex = cloudResources.findIndex(r => r.id === resource.id);
                                    if (resourceIndex !== -1) {
                                        cloudResources[resourceIndex].viewCount = resource.viewCount;
                                        cloudResources[resourceIndex].downloadCount = resource.downloadCount;
                                        
                                        // 更新用户下载次数
                                        const loggedUser = localStorage.getItem('loggedUser');
                                        if (loggedUser) {
                                            const userIndex = cloudUsers.findIndex(u => u.username === loggedUser);
                                            if (userIndex !== -1) {
                                                cloudUsers[userIndex].downloadCount = users[userIndex]?.downloadCount || 0;
                                            }
                                        }
                                        
                                        await saveCloudData(cloudUsers, cloudResources);
                                        console.log('✅ 下载统计已同步到云端');
                                    }
                                } catch (error) {
                                    console.error('❌ 同步下载统计失败:', error);
                                }
                            })();
                            
                        } else {
                            showToast('该资源暂无下载链接', 'warning');
                        }
                    });
                }
            });
            
            // 绑定收藏按钮事件
            document.querySelectorAll('.collect-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation(); // 阻止冒泡到卡片点击事件
                    const loggedUser = localStorage.getItem('loggedUser');
                    if (!loggedUser) {
                        showToast('请先登录后收藏', 'warning');
                        return;
                    }
                    
                    const index = parseInt(btn.dataset.index);
                    const resource = resources[index];
                    
                    // 切换收藏状态
                    if (!resource.collectUsers) resource.collectUsers = [];
                    const collectIndex = resource.collectUsers.indexOf(loggedUser);
                    
                    if (collectIndex === -1) {
                        // 收藏
                        resource.collectUsers.push(loggedUser);
                        showToast('收藏成功');
                        btn.querySelector('i').className = 'fa fa-star text-yellow-500';
                    } else {
                        // 取消收藏
                        resource.collectUsers.splice(collectIndex, 1);
                        showToast('取消收藏');
                        btn.querySelector('i').className = 'fa fa-star-o text-gray-400';
                    }
                    
                    // 保存数据到本地存储
                    localStorage.setItem('resources', JSON.stringify(resources));
                    
                    // 异步更新到云存储
                    (async () => {
                        try {
                            const { users: cloudUsers, resources: cloudResources } = await getCloudData();
                            const resourceIndex = cloudResources.findIndex(r => r.id === resource.id);
                            if (resourceIndex !== -1) {
                                cloudResources[resourceIndex].collectUsers = resource.collectUsers;
                                await saveCloudData(cloudUsers, cloudResources);
                                console.log('✅ 收藏状态已同步到云端');
                            }
                        } catch (error) {
                            console.error('❌ 同步收藏状态失败:', error);
                        }
                    })();
                    
                    // 更新个人中心收藏列表
                    loadProfileData();
                });
            });
            
            // 绑定评论切换按钮事件
            document.querySelectorAll('.comment-toggle-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(btn.dataset.index);
                    const commentSection = document.querySelector(`.comment-section[data-index="${index}"]`);
                    commentSection.classList.toggle('hidden');
                });
            });
            
            // 绑定评论提交按钮事件
            document.querySelectorAll('.comment-submit-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const loggedUser = localStorage.getItem('loggedUser');
                    if (!loggedUser) {
                        showToast('请先登录后发表评论', 'warning');
                        return;
                    }
                    
                    const index = parseInt(btn.dataset.index);
                    const input = document.querySelector(`.comment-input[data-index="${index}"]`);
                    const content = input.value.trim();
                    
                    if (!content) {
                        showToast('评论内容不能为空', 'warning');
                        return;
                    }
                    
                    const resource = resources[index];
                    if (!resource.comments) resource.comments = [];
                    
                    // 添加新评论
                    const newComment = {
                        user: loggedUser,
                        content: content,
                        time: new Date().toLocaleString()
                    };
                    
                    resource.comments.push(newComment);
                    
                    // 保存数据到本地存储
                    localStorage.setItem('resources', JSON.stringify(resources));
                    
                    // 更新评论列表
                    const commentList = document.querySelector(`.comment-list[data-index="${index}"]`);
                    const commentHtml = `
                        <div class="comment-item bg-gray-50 p-3 rounded-lg">
                            <div class="flex justify-between items-start">
                                <span class="font-medium text-sm">${newComment.user}</span>
                                <span class="text-xs text-gray-400">${newComment.time}</span>
                            </div>
                            <p class="text-sm mt-1">${newComment.content}</p>
                        </div>
                    `;
                    
                    // 如果之前是空的，先清空提示文字
                    if (resource.comments.length === 1) {
                        commentList.innerHTML = '';
                    }
                    
                    commentList.insertAdjacentHTML('beforeend', commentHtml);
                    input.value = '';
                    
                    // 更新评论数显示
                    btn.closest('.p-5').querySelector('.comment-toggle-btn').innerHTML = 
                        `<i class="fa fa-comment-o mr-1"></i> 评论(${resource.comments.length})`;
                    
                    showToast('评论发表成功');
                    
                    // 异步更新到云存储
                    (async () => {
                        try {
                            const { users: cloudUsers, resources: cloudResources } = await getCloudData();
                            const resourceIndex = cloudResources.findIndex(r => r.id === resource.id);
                            if (resourceIndex !== -1) {
                                cloudResources[resourceIndex].comments = resource.comments;
                                await saveCloudData(cloudUsers, cloudResources);
                                console.log('✅ 评论已同步到云端');
                            }
                        } catch (error) {
                            console.error('❌ 同步评论失败:', error);
                        }
                    })();
                });
            });
        }

        // 检查登录状态
        async function checkLoginStatus() {
            const userMenu = document.getElementById('userMenu');
            const authButtons = document.getElementById('authButtons');
            const uploadFormContainer = document.getElementById('uploadFormContainer');
            const uploadNotLoggedIn = document.getElementById('uploadNotLoggedIn');
            const profileContent = document.getElementById('profileContent');
            const profileNotLoggedIn = document.getElementById('profileNotLoggedIn');
            
            const loggedUser = localStorage.getItem('loggedUser');
            if (loggedUser) {
                userMenu.classList.remove('hidden');
                authButtons.classList.add('hidden');
                uploadFormContainer.classList.remove('hidden');
                uploadNotLoggedIn.classList.add('hidden');
                profileContent.classList.remove('hidden');
                profileNotLoggedIn.classList.add('hidden');
                document.getElementById('usernameDisplay').textContent = loggedUser;
                document.getElementById('profileUsername').textContent = loggedUser;
                
                // 设置用户加入时间（从云存储获取）
                if (isCloudReady) {
                    try {
                        const { users } = await getCloudData();
                        const user = users.find(u => u.username === loggedUser);
                        if (user) {
                            document.getElementById('profileJoinTime').textContent = user.joinTime || new Date().toLocaleDateString();
                            document.getElementById('profileDownloadCount').textContent = user.downloadCount || 0;
                            document.getElementById('profileNewUsername').value = loggedUser;
                        }
                    } catch (error) {
                        console.error('获取用户信息失败:', error);
                    }
                }
            } else {
                userMenu.classList.add('hidden');
                authButtons.classList.remove('hidden');
                uploadFormContainer.classList.add('hidden');
                uploadNotLoggedIn.classList.remove('hidden');
                profileContent.classList.add('hidden');
                profileNotLoggedIn.classList.remove('hidden');
            }
        }

        // 加载个人中心数据
        async function loadProfileData() {
            // 先检查登录状态
            await checkLoginStatus();
            
            const loggedUser = localStorage.getItem('loggedUser');
            if (!loggedUser) return;
            
            let resources = [];
            // 获取资源数据
            if (isCloudReady) {
                try {
                    const res = await getCloudData();
                    resources = res.resources;
                } catch (error) {
                    resources = JSON.parse(localStorage.getItem('resources') || '[]');
                }
            } else {
                resources = JSON.parse(localStorage.getItem('resources') || '[]');
            }
            
            // 我的上传
            const myUploads = resources.filter(r => r.uploader === loggedUser);
            const myUploadsList = document.getElementById('myUploadsList');
            const myUploadsEmpty = document.getElementById('myUploadsEmpty');
            
            if (myUploads.length > 0) {
                myUploadsEmpty.classList.add('hidden');
                myUploadsList.innerHTML = '';
                myUploads.forEach(resource => {
                    const fileSize = (resource.fileSize / 1024 / 1024).toFixed(2) + 'MB';
                    const categoryText = {
                        'tutorial': '辩论教程',
                        'video': '赛事视频',
                        'analysis': '辩题分析',
                        'strategy': '技巧策略'
                    }[resource.category] || '其他';
                    
                    const uploadItem = `
                        <div class="border border-gray-100 rounded-lg p-4 hover:shadow-sm transition-all">
                            <div class="flex justify-between items-start mb-2">
                                <span class="px-2 py-1 bg-primary/10 text-primary text-xs rounded-full">${categoryText}</span>
                                <span class="text-xs text-gray-500">${resource.uploadTime}</span>
                            </div>
                            <h4 class="font-medium mb-2">${resource.title}</h4>
                            <div class="flex justify-between text-sm text-gray-500">
                                <span>下载量：${resource.downloadCount || 0}</span>
                                <span>大小：${fileSize}</span>
                            </div>
                        </div>
                    `;
                    myUploadsList.innerHTML += uploadItem;
                });
            } else {
                myUploadsEmpty.classList.remove('hidden');
            }
            
            // 我的收藏
            const myCollections = resources.filter(r => r.collectUsers && r.collectUsers.includes(loggedUser));
            const myCollectionsList = document.getElementById('myCollectionsList');
            const myCollectionsEmpty = document.getElementById('myCollectionsEmpty');
            
            if (myCollections.length > 0) {
                myCollectionsEmpty.classList.add('hidden');
                myCollectionsList.innerHTML = '';
                myCollections.forEach(resource => {
                    const fileSize = (resource.fileSize / 1024 / 1024).toFixed(2) + 'MB';
                    const categoryText = {
                        'tutorial': '辩论教程',
                        'video': '赛事视频',
                        'analysis': '辩题分析',
                        'strategy': '技巧策略'
                    }[resource.category] || '其他';
                    
                    const collectItem = `
                        <div class="border border-gray-100 rounded-lg p-4 hover:shadow-sm transition-all">
                            <div class="flex justify-between items-start mb-2">
                                <span class="px-2 py-1 bg-primary/10 text-primary text-xs rounded-full">${categoryText}</span>
                                <button class="text-gray-400 hover:text-red-500 uncollect-btn" data-id="${resource.id}">
                                    <i class="fa fa-star text-yellow-500 mr-1"></i> 取消收藏
                                </button>
                            </div>
                            <h4 class="font-medium mb-2">${resource.title}</h4>
                            <div class="flex justify-between text-sm text-gray-500">
                                <span>上传者：${resource.uploader}</span>
                                <span>大小：${fileSize}</span>
                            </div>
                        </div>
                    `;
                    myCollectionsList.innerHTML += collectItem;
                });
                
                // 绑定取消收藏按钮事件
                document.querySelectorAll('.uncollect-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const resourceId = btn.dataset.id;
                        const resource = resources.find(r => r.id === resourceId);
                        if (resource) {
                            const collectIndex = resource.collectUsers.indexOf(loggedUser);
                            if (collectIndex !== -1) {
                                resource.collectUsers.splice(collectIndex, 1);
                                
                                // 保存数据
                                if (isCloudReady) {
                                    db.collection('resources').doc(resource._id).update({
                                        data: { collectUsers: resource.collectUsers }
                                    });
                                } else {
                                    localStorage.setItem('resources', JSON.stringify(resources));
                                }
                                
                                showToast('取消收藏成功');
                                loadProfileData();
                                loadResourcesList();
                            }
                        }
                    });
                });
            } else {
                myCollectionsEmpty.classList.remove('hidden');
            }
            
            // 更新统计数字
            document.getElementById('profileUploadCount').textContent = myUploads.length;
            document.getElementById('profileCollectCount').textContent = myCollections.length;
        }

        // 绑定所有事件
        function bindEvents() {
            console.log('🔧 开始绑定事件...');
            
            // 1. 标签页切换事件
            try {
                document.querySelectorAll('.nav-tab').forEach(btn => {
                    btn.addEventListener('click', () => {
                        console.log('标签页点击:', btn.dataset.tab);
                        switchTab(btn.dataset.tab);
                    });
                });
                console.log('✅ 标签页切换事件绑定成功');
            } catch (error) {
                console.error('❌ 标签页事件绑定失败:', error);
            }

            // 2. 个人中心子标签切换事件
            try {
                document.querySelectorAll('.profile-subtab').forEach(btn => {
                    btn.addEventListener('click', () => {
                        console.log('子标签页点击:', btn.dataset.subtab);
                        switchProfileSubtab(btn.dataset.subtab);
                    });
                });
                console.log('✅ 子标签页切换事件绑定成功');
            } catch (error) {
                console.error('❌ 子标签页事件绑定失败:', error);
            }

            // 3. 登录/注册弹窗事件
            try {
                const authModal = document.getElementById('authModal');
                const loginBtn = document.getElementById('loginBtn');
                const registerBtn = document.getElementById('registerBtn');
                const closeAuthModal = document.getElementById('closeAuthModal');
                const switchToRegister = document.getElementById('switchToRegister');
                const switchToLogin = document.getElementById('switchToLogin');
                const authLoginForm = document.getElementById('authLoginForm');
                const authRegisterForm = document.getElementById('authRegisterForm');
                const authModalTitle = document.getElementById('authModalTitle');
                const uploadLoginBtn = document.getElementById('uploadLoginBtn');
                const profileLoginBtn = document.getElementById('profileLoginBtn');

                console.log('✅ 找到所有登录/注册相关元素');

                // 打开登录弹窗
                function openLoginModal() {
                    console.log('打开登录弹窗');
                    if (authModal && authLoginForm && authRegisterForm && authModalTitle) {
                        authModal.classList.remove('hidden');
                        authLoginForm.classList.remove('hidden');
                        authRegisterForm.classList.add('hidden');
                        authModalTitle.textContent = '用户登录';
                    }
                }

                if (loginBtn) {
                    loginBtn.addEventListener('click', openLoginModal);
                    console.log('✅ 登录按钮事件绑定成功');
                }

                if (uploadLoginBtn) {
                    uploadLoginBtn.addEventListener('click', openLoginModal);
                    console.log('✅ 上传页面登录按钮事件绑定成功');
                }

                if (profileLoginBtn) {
                    profileLoginBtn.addEventListener('click', openLoginModal);
                    console.log('✅ 个人中心登录按钮事件绑定成功');
                }

                // 打开注册弹窗
                if (registerBtn) {
                    registerBtn.addEventListener('click', () => {
                        console.log('打开注册弹窗');
                        if (authModal && authLoginForm && authRegisterForm && authModalTitle) {
                            authModal.classList.remove('hidden');
                            authLoginForm.classList.add('hidden');
                            authRegisterForm.classList.remove('hidden');
                            authModalTitle.textContent = '用户注册';
                        }
                    });
                    console.log('✅ 注册按钮事件绑定成功');
                }

                // 关闭弹窗
                if (closeAuthModal) {
                    closeAuthModal.addEventListener('click', () => {
                        console.log('关闭弹窗');
                        if (authModal) {
                            authModal.classList.add('hidden');
                        }
                    });
                    console.log('✅ 关闭按钮事件绑定成功');
                }

                // 切换登录/注册
                if (switchToRegister) {
                    switchToRegister.addEventListener('click', (e) => {
                        e.preventDefault();
                        console.log('切换到注册');
                        if (authLoginForm && authRegisterForm && authModalTitle) {
                            authLoginForm.classList.add('hidden');
                            authRegisterForm.classList.remove('hidden');
                            authModalTitle.textContent = '用户注册';
                        }
                    });
                    console.log('✅ 登录转注册事件绑定成功');
                }

                if (switchToLogin) {
                    switchToLogin.addEventListener('click', (e) => {
                        e.preventDefault();
                        console.log('切换到登录');
                        if (authLoginForm && authRegisterForm && authModalTitle) {
                            authLoginForm.classList.remove('hidden');
                            authRegisterForm.classList.add('hidden');
                            authModalTitle.textContent = '用户登录';
                        }
                    });
                    console.log('✅ 注册转登录事件绑定成功');
                }

                // 点击弹窗外部关闭
                window.addEventListener('click', (e) => {
                    if (e.target === authModal) {
                        console.log('点击弹窗外部关闭');
                        authModal.classList.add('hidden');
                    }
                });
            } catch (error) {
                console.error('❌ 登录/注册事件绑定失败:', error);
            }

            // 4. 登录按钮事件
            try {
                const doLoginBtn = document.getElementById('doLoginBtn');
                if (doLoginBtn) {
                    doLoginBtn.addEventListener('click', async () => {
                        console.log('点击登录按钮');
                        
                        // 获取输入值
                        const username = document.getElementById('loginUsername')?.value;
                        const password = document.getElementById('loginPassword')?.value;
                        
                        // 验证输入
                        if (!username || !password) {
                            showToast('请输入用户名和密码', 'error');
                            return;
                        }
                        
                        // 显示加载状态
                        const originalText = doLoginBtn.textContent;
                        doLoginBtn.textContent = '登录中...';
                        doLoginBtn.disabled = true;
                        
                        try {
                            // 从云存储获取用户数据
                            console.log('📡 从云存储验证用户...');
                            
                            const { users } = await getCloudData();
                            const user = users.find(u => u.username === username && u.password === password);

                            if (user) {
                                localStorage.setItem('loggedUser', username); // 用于保持会话
                                const authModal = document.getElementById('authModal');
                                if (authModal) {
                                    authModal.classList.add('hidden');
                                }
                                checkLoginStatus();
                                loadProfileData();
                                showToast('登录成功');
                                console.log('✅ 登录成功（云存储验证）');
                                
                                // 清空表单
                                document.getElementById('loginUsername').value = '';
                                document.getElementById('loginPassword').value = '';
                            } else {
                                showToast('用户名或密码错误', 'error');
                                console.log('❌ 登录失败：用户名或密码错误');
                            }
                        } catch (error) {
                            console.error('❌ 登录过程出错:', error);
                            showToast('登录失败: ' + error.message, 'error');
                        } finally {
                            // 恢复按钮状态
                            doLoginBtn.textContent = originalText;
                            doLoginBtn.disabled = false;
                        }
                    });
                    console.log('✅ 登录按钮事件绑定成功');
                }
            } catch (error) {
                console.error('❌ 登录按钮事件绑定失败:', error);
            }

            // 5. 注册按钮事件
            try {
                const doRegisterBtn = document.getElementById('doRegisterBtn');
                if (doRegisterBtn) {
                    doRegisterBtn.addEventListener('click', async () => {
                        console.log('点击注册按钮');
                        
                        // 获取输入值
                        const username = document.getElementById('registerUsername')?.value;
                        const password = document.getElementById('registerPassword')?.value;
                        const confirmPwd = document.getElementById('registerConfirmPassword')?.value;
                        
                        // 验证输入
                        if (!username || !password || !confirmPwd) {
                            showToast('请填写完整的注册信息', 'error');
                            return;
                        }
                        
                        if (password !== confirmPwd) {
                            showToast('两次输入的密码不一致', 'error');
                            return;
                        }
                        
                        if (password.length < 6) {
                            showToast('密码长度至少为6位', 'error');
                            return;
                        }
                        
                        // 显示加载状态
                        const originalText = doRegisterBtn.textContent;
                        doRegisterBtn.textContent = '注册中...';
                        doRegisterBtn.disabled = true;
                        
                        try {
                            // 从云存储获取用户数据
                            console.log('📡 从云存储获取用户数据...');
                            
                            // 获取现有用户数据
                            let { users, resources } = await getCloudData();

                            if (users.some(u => u.username === username)) {
                                showToast('用户名已存在', 'error');
                                return;
                            }

                            // 创建新用户
                            const newUser = { 
                                username, 
                                password, 
                                joinTime: new Date().toLocaleDateString(),
                                downloadCount: 0
                            };
                            
                            // 添加到用户列表
                            users.push(newUser);
                            
                            // 保存到云存储
                            const success = await saveCloudData(users, resources);
                            if (!success) {
                                throw new Error('保存到云存储失败');
                            }
                            
                            // 同时更新本地存储
                            localStorage.setItem('users', JSON.stringify(users));
                            localStorage.setItem('resources', JSON.stringify(resources));
                            console.log('✅ 用户数据已保存到云存储和本地存储');

                            const authModal = document.getElementById('authModal');
                            if (authModal) {
                                authModal.classList.add('hidden');
                            }
                            showToast('注册成功，请登录');
                            console.log('✅ 注册成功（已同步到云端）');
                            
                            // 清空表单
                            document.getElementById('registerUsername').value = '';
                            document.getElementById('registerPassword').value = '';
                            document.getElementById('registerConfirmPassword').value = '';
                            
                            // 切换到登录表单
                            document.getElementById('authLoginForm').classList.remove('hidden');
                            document.getElementById('authRegisterForm').classList.add('hidden');
                            document.getElementById('authModalTitle').textContent = '用户登录';
                        } catch (error) {
                            console.error('❌ 注册过程出错:', error);
                            showToast('注册失败: ' + error.message, 'error');
                        } finally {
                            // 恢复按钮状态
                            doRegisterBtn.textContent = originalText;
                            doRegisterBtn.disabled = false;
                        }
                    });
                    console.log('✅ 注册按钮事件绑定成功');
                }
            } catch (error) {
                console.error('❌ 注册按钮事件绑定失败:', error);
            }

            // 6. 登出按钮事件
            try {
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => {
                        console.log('点击登出按钮');
                        try {
                            localStorage.removeItem('loggedUser');
                            checkLoginStatus();
                            showToast('已成功登出');
                            console.log('✅ 登出成功');
                        } catch (error) {
                            console.error('❌ 登出过程出错:', error);
                            showToast('登出失败: ' + error.message, 'error');
                        }
                    });
                    console.log('✅ 登出按钮事件绑定成功');
                }
            } catch (error) {
                console.error('❌ 登出按钮事件绑定失败:', error);
            }

            // 7. 计时器相关事件
            const startBtn = document.getElementById('start-btn');
            const pauseBtn = document.getElementById('pause-btn');
            const resetBtn = document.getElementById('reset-btn');
            const countdownModeBtn = document.getElementById('countdown-mode');
            const stopwatchModeBtn = document.getElementById('stopwatch-mode');
            const hoursInput = document.getElementById('hours');
            const minutesInput = document.getElementById('minutes');
            const secondsInput = document.getElementById('seconds');
            const timerStatus = document.getElementById('timer-status');

            // 模式切换
            countdownModeBtn.addEventListener('click', () => {
                timerMode = 'countdown';
                countdownModeBtn.classList.remove('bg-gray-200', 'text-gray-700');
                countdownModeBtn.classList.add('bg-primary', 'text-white');
                stopwatchModeBtn.classList.remove('bg-primary', 'text-white');
                stopwatchModeBtn.classList.add('bg-gray-200', 'text-gray-700');
                resetTimer();
            });

            stopwatchModeBtn.addEventListener('click', () => {
                timerMode = 'stopwatch';
                stopwatchModeBtn.classList.remove('bg-gray-200', 'text-gray-700');
                stopwatchModeBtn.classList.add('bg-primary', 'text-white');
                countdownModeBtn.classList.remove('bg-primary', 'text-white');
                countdownModeBtn.classList.add('bg-gray-200', 'text-gray-700');
                resetTimer();
            });

            // 开始计时
            startBtn.addEventListener('click', () => {
                if (isTimerRunning) return;

                isTimerRunning = true;
                startBtn.classList.add('hidden');
                pauseBtn.classList.remove('hidden');
                timerStatus.textContent = '计时中...';

                // 禁用时间输入
                hoursInput.disabled = true;
                minutesInput.disabled = true;
                secondsInput.disabled = true;

                timerInterval = setInterval(() => {
                    if (timerMode === 'countdown') {
                        remainingSeconds--;
                        if (remainingSeconds <= 0) {
                            clearInterval(timerInterval);
                            document.getElementById('complete-sound').play();
                            timerStatus.textContent = '计时结束';
                            resetTimer();
                            return;
                        } else if (remainingSeconds <= 10) {
                            document.getElementById('warning-sound').play();
                            timerStatus.textContent = '即将结束!';
                        }
                    } else {
                        remainingSeconds++;
                        timerStatus.textContent = '计时中...';
                    }
                    updateTimerDisplay();
                }, 1000);
            });

            // 暂停计时
            pauseBtn.addEventListener('click', () => {
                clearInterval(timerInterval);
                isTimerRunning = false;
                startBtn.classList.remove('hidden');
                pauseBtn.classList.add('hidden');
                timerStatus.textContent = '已暂停';
            });

            // 重置计时器
            function resetTimer() {
                clearInterval(timerInterval);
                isTimerRunning = false;
                startBtn.classList.remove('hidden');
                pauseBtn.classList.add('hidden');
                
                // 启用时间输入
                hoursInput.disabled = false;
                minutesInput.disabled = false;
                secondsInput.disabled = false;

                if (timerMode === 'countdown') {
                    totalSeconds = parseInt(hoursInput.value) * 3600 + parseInt(minutesInput.value) * 60 + parseInt(secondsInput.value);
                    remainingSeconds = totalSeconds;
                    timerStatus.textContent = '准备就绪';
                } else {
                    remainingSeconds = 0;
                    timerStatus.textContent = '准备就绪';
                }
                updateTimerDisplay();
            }

            resetBtn.addEventListener('click', resetTimer);

            // 预设时间按钮
            document.querySelectorAll('.preset-time').forEach(btn => {
                btn.addEventListener('click', () => {
                    const minutes = parseInt(btn.dataset.minutes);
                    minutesInput.value = minutes;
                    hoursInput.value = 0;
                    secondsInput.value = 0;
                    resetTimer();
                });
            });

            // 时间输入框变化时更新
            [hoursInput, minutesInput, secondsInput].forEach(input => {
                input.addEventListener('change', resetTimer);
            });

            // 8. 文件上传相关事件（核心：真正的文件上传）
            const fileInput = document.getElementById('fileInput');
            const fileUploadArea = document.getElementById('fileUploadArea');
            const filePreview = document.getElementById('filePreview');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const removeFile = document.getElementById('removeFile');

            // 点击上传区域触发文件选择
            fileUploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            // 拖拽上传
            fileUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadArea.classList.add('border-primary');
            });

            fileUploadArea.addEventListener('dragleave', () => {
                fileUploadArea.classList.remove('border-primary');
            });

            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadArea.classList.remove('border-primary');
                if (e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileSelect();
                }
            });

            // 文件选择后预览
            fileInput.addEventListener('change', handleFileSelect);

            function handleFileSelect() {
                if (fileInput.files.length === 0) return;
                
                const file = fileInput.files[0];
                fileName.textContent = file.name;
                fileSize.textContent = (file.size / 1024 / 1024).toFixed(2) + 'MB';
                filePreview.classList.remove('hidden');
            }

            // 移除文件
            removeFile.addEventListener('click', () => {
                fileInput.value = '';
                filePreview.classList.add('hidden');
            });

            // 9. 文件上传（云存储模式）
            document.getElementById('uploadForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // 1. 验证表单
                const title = document.getElementById('resourceTitle').value;
                const category = document.getElementById('resourceCategory').value;
                const file = fileInput.files[0];
                if (!title || !category || !file) {
                    showToast('请填写完整信息并选择文件', 'error');
                    return;
                }

                // 2. 验证 Cloudinary 配置
                if (!CLOUDINARY_CLOUD_NAME || !CLOUDINARY_UPLOAD_PRESET) {
                    showToast('Cloudinary 配置不完整', 'error');
                    return;
                }

                // 3. 显示上传中提示
                showToast('资源上传中...', 'warning');
                
                try {
                    // 4. 上传文件到 Cloudinary
                    console.log('☁️ 上传文件到 Cloudinary...');
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                    formData.append('cloud_name', CLOUDINARY_CLOUD_NAME);
                    
                    const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message || '上传失败');
                    
                    console.log('✅ 文件上传成功:', result.secure_url);

                    // 5. 创建资源信息
                    const resourceInfo = {
                        id: 'res_' + Date.now(),
                        title: title,
                        category: category,
                        description: document.getElementById('resourceDescription').value || '无描述',
                        fileName: file.name,
                        fileSize: file.size,
                        fileType: file.type,
                        fileUrl: result.secure_url, // Cloudinary 永久链接
                        fileId: result.public_id,
                        uploader: localStorage.getItem('loggedUser') || '匿名用户',
                        uploadTime: new Date().toLocaleDateString(),
                        downloadCount: 0,
                        viewCount: 0,
                        comments: [],
                        collectUsers: [],
                        createdAt: new Date()
                    };

                    // 6. 保存资源信息到云存储
                    console.log('🔄 保存资源信息到云存储...');
                    let { users, resources } = await getCloudData();
                    resources.push(resourceInfo);
                    
                    const success = await saveCloudData(users, resources);
                    if (!success) {
                        throw new Error('保存到云存储失败');
                    }
                    
                    // 同时更新本地存储
                    localStorage.setItem('resources', JSON.stringify(resources));
                    console.log('✅ 资源信息已保存到云存储和本地存储');

                    // 7. 提示成功并重置表单
                    showToast('资源上传成功！');
                    e.target.reset();
                    filePreview.classList.add('hidden');
                    loadResourcesList(); // 重新加载资源列表
                    
                } catch (error) {
                    console.error('上传失败:', error);
                    showToast(`上传失败：${error.message}`, 'error');
                }
            });

            // 10. 高级搜索按钮事件
            document.getElementById('advancedSearchBtn').addEventListener('click', () => {
                loadResourcesList();
                showToast('筛选条件已应用');
            });

            // 11. 重置搜索按钮事件
            document.getElementById('resetSearchBtn').addEventListener('click', () => {
                document.getElementById('resourceSearch').value = '';
                document.getElementById('categoryFilter').value = '';
                document.getElementById('sortFilter').value = '';
                document.getElementById('uploaderFilter').value = '';
                document.getElementById('sizeFilter').value = '';
                loadResourcesList();
                showToast('筛选条件已重置');
            });

            // 12. 个人信息修改表单提交
            document.getElementById('profileForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const loggedUser = localStorage.getItem('loggedUser');
                if (!loggedUser) return;

                const newUsername = document.getElementById('profileNewUsername').value.trim();
                const newPassword = document.getElementById('profileNewPassword').value;
                const confirmPassword = document.getElementById('profileConfirmPassword').value;

                if (!newUsername) {
                    showToast('用户名不能为空', 'error');
                    return;
                }

                if (newPassword && newPassword !== confirmPassword) {
                    showToast('两次输入的密码不一致', 'error');
                    return;
                }

                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const userIndex = users.findIndex(u => u.username === loggedUser);
                
                if (userIndex !== -1) {
                    // 更新用户名
                    users[userIndex].username = newUsername;
                    // 更新密码（如果填写了）
                    if (newPassword) {
                        users[userIndex].password = newPassword;
                    }
                    
                    localStorage.setItem('users', JSON.stringify(users));
                    
                    // 更新本地存储中资源的上传者信息
                    const resources = JSON.parse(localStorage.getItem('resources') || '[]');
                    resources.forEach(resource => {
                        if (resource.uploader === loggedUser) {
                            resource.uploader = newUsername;
                        }
                    });
                    localStorage.setItem('resources', JSON.stringify(resources));
                    
                    // 更新收藏用户信息
                    resources.forEach(resource => {
                        if (resource.collectUsers && resource.collectUsers.includes(loggedUser)) {
                            const index = resource.collectUsers.indexOf(loggedUser);
                            resource.collectUsers[index] = newUsername;
                        }
                    });
                    localStorage.setItem('resources', JSON.stringify(resources));
                    
                    // 更新评论用户信息
                    resources.forEach(resource => {
                        if (resource.comments) {
                            resource.comments.forEach(comment => {
                                if (comment.user === loggedUser) {
                                    comment.user = newUsername;
                                }
                            });
                        }
                    });
                    localStorage.setItem('resources', JSON.stringify(resources));
                    
                    // 更新登录状态
                    localStorage.setItem('loggedUser', newUsername);
                    
                    showToast('个人信息修改成功');
                    checkLoginStatus();
                    loadProfileData();
                    loadResourcesList();
                }
            });

            // 13. 回车键触发搜索
            document.getElementById('resourceSearch').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    loadResourcesList();
                }
            });

            // 14. 回车键触发评论提交
            document.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.target.classList.contains('comment-input')) {
                    const index = e.target.dataset.index;
                    const submitBtn = document.querySelector(`.comment-submit-btn[data-index="${index}"]`);
                    if (submitBtn) {
                        submitBtn.click();
                    }
                }
            });
        }

        // 确保云存储连接正常，如果不正常则尝试重新连接
        async function ensureCloudStorage() {
            if (!isCloudReady) {
                console.log('☁️ 云存储未就绪，尝试重新初始化...');
                await initCloudBase();
            }
            return isCloudReady;
        }
        
        // 测试脚本（直接暴露到全局作用域）
        window.testLoginFunctionality = function() {
            console.log('=== 开始测试登录功能 ===');
            
            // 1. 检查登录按钮是否存在
            const doLoginBtn = document.getElementById('doLoginBtn');
            console.log('doLoginBtn:', doLoginBtn);
            if (!doLoginBtn) {
                console.error('❌ 找不到登录按钮');
                return;
            }
            
            // 2. 检查输入框是否存在
            const loginUsername = document.getElementById('loginUsername');
            const loginPassword = document.getElementById('loginPassword');
            console.log('loginUsername:', loginUsername);
            console.log('loginPassword:', loginPassword);
            
            // 3. 检查事件监听器
            console.log('事件监听器是否存在:', typeof doLoginBtn.addEventListener === 'function');
            
            // 4. 尝试直接触发点击事件
            console.log('尝试直接触发登录按钮点击事件');
            try {
                doLoginBtn.click();
                console.log('✅ 登录按钮点击事件成功触发');
            } catch (error) {
                console.error('❌ 触发点击事件失败:', error);
            }
            
            // 5. 检查是否有任何内联事件
            console.log('内联事件:', doLoginBtn.getAttribute('onclick'));
            
            // 6. 检查控制台是否有错误
            console.log('=== 测试完成 ===');
        };
        
        // 查看本地存储中的用户列表
        window.showLocalUsers = function() {
            console.log('=== 本地存储用户列表 ===');
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            console.log(`用户总数: ${users.length}`);
            if (users.length > 0) {
                users.forEach((user, index) => {
                    console.log(`${index + 1}. ${user.username} (加入时间: ${user.joinTime})`);
                });
            } else {
                console.log('暂无用户，请先注册');
            }
            console.log('========================');
            return users;
        };

        // 测试配置值
        window.testConfigValues = function() {
            console.log('=== 检查配置值 ===');
            console.log('GIST_ID:', GIST_ID);
            console.log('GITHUB_TOKEN:', GITHUB_TOKEN);
            
            // 检查是否使用了正确的默认值
            if (GIST_ID === "YOUR_GIST_ID" || GITHUB_TOKEN === "YOUR_GITHUB_TOKEN") {
                console.error('❌ 配置值未正确设置');
            } else {
                console.log('✅ 配置值已正确设置');
            }
        };

        // 测试云存储连接
        window.testCloudStorageConnection = async function() {
            console.log('=== 测试云存储连接 ===');
            try {
                console.log('检查云存储是否已初始化:', isCloudReady);
                if (!isCloudReady) {
                    console.log('云存储未初始化，尝试初始化...');
                    const success = await initCloudBase();
                    console.log('初始化结果:', success);
                }
                
                if (isCloudReady) {
                    console.log('云存储已就绪，尝试获取数据...');
                    const data = await getCloudData();
                    console.log('用户数量:', data.users.length);
                    console.log('资源数量:', data.resources.length);
                    
                    if (data.users.length > 0) {
                        console.log('用户列表:', data.users.map(user => user.username));
                    }
                }
            } catch (error) {
                console.error('❌ 云存储测试失败:', error);
            }
        };

        // 执行完整测试
        window.runFullTest = async function() {
            window.testLoginFunctionality();
            window.testConfigValues();
            await window.testCloudStorageConnection();
        };

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 页面开始初始化...');
            console.log('☁️ 云存储模式已启用');
            console.log('💡 提示：所有数据将同步到 GitHub Gist 和 Cloudinary');
            
            // 显示云服务配置信息
            console.log('📁 Cloudinary:', CLOUDINARY_CLOUD_NAME);
            console.log('🔄 GitHub Gist:', GIST_ID);
            
            try {
                // 初始化云存储（现在默认使用本地存储）
                console.log('☁️ 初始化存储系统...');
                await initCloudBase();
                console.log('存储模式:', isCloudReady ? '✅ 云存储模式' : '✅ 本地存储模式');
                
                // 检查登录状态
                console.log('🔐 检查登录状态...');
                await checkLoginStatus();
                
                // 加载资源列表
                console.log('📚 加载资源列表...');
                await loadResourcesList();
                
                // 绑定所有事件
                console.log('🔧 绑定事件...');
                bindEvents();
                
                // 初始化计时器显示
                console.log('⏱️ 初始化计时器显示...');
                updateTimerDisplay();
                
                // 默认显示首页
                console.log('🏠 默认显示首页...');
                switchTab('home');
                
                console.log('🎉 页面初始化完成！');
                console.log('💡 使用提示：');
                console.log('  - 所有用户数据保存在浏览器本地（localStorage）');
                console.log('  - 刷新页面后数据仍然保留');
                console.log('  - 清除浏览器缓存会删除数据');
                console.log('  - 在控制台输入 showLocalUsers() 查看所有用户');
                
                // 添加登录/注册按钮状态检查
                setTimeout(() => {
                    const loginBtn = document.getElementById('doLoginBtn');
                    const registerBtn = document.getElementById('doRegisterBtn');
                    if (loginBtn) {
                        console.log('✅ 登录按钮已就绪，事件监听器已绑定');
                    } else {
                        console.error('❌ 登录按钮未找到');
                    }
                    if (registerBtn) {
                        console.log('✅ 注册按钮已就绪，事件监听器已绑定');
                    } else {
                        console.error('❌ 注册按钮未找到');
                    }
                }, 1000);
                
                // GitHub Pages 环境提示
                if (window.location.hostname.includes('github') || window.location.hostname.includes('github.io')) {
                    console.log('ℹ️ GitHub Pages 环境检测到：应用使用本地存储模式，所有功能正常');
                }
                
            } catch (error) {
                console.error('❌ 页面初始化失败:', error);
                // 对于 GitHub Pages，不显示错误提示，避免用户困惑
                if (!window.location.hostname.includes('github') && !window.location.hostname.includes('github.io')) {
                    showToast('页面初始化失败: ' + error.message, 'error');
                }
                
                // 即使初始化失败，也要确保至少显示首页
                try {
                    switchTab('home');
                    console.log('🏠 强制显示首页');
                } catch (tabError) {
                    console.error('❌ 无法切换到首页:', tabError);
                }
            }
        });

        // 直接在全局作用域中暴露调试功能
        // 显示登录弹窗函数
        window.showLoginModal = function() {
            console.log('📺 尝试直接显示登录弹窗');
            const authModal = document.getElementById('authModal');
            if (authModal) {
                authModal.classList.remove('hidden');
                console.log('✅ 登录弹窗已显示');
            } else {
                console.error('❌ 无法找到登录弹窗');
            }
        };
        
        // 调试登录功能
        window.debugLogin = function() {
            console.log('🔍 调试登录功能:');
            const loginBtn = document.getElementById('doLoginBtn');
            const loginUsername = document.getElementById('loginUsername');
            const loginPassword = document.getElementById('loginPassword');
            console.log('登录按钮:', loginBtn);
            console.log('用户名输入框:', loginUsername);
            console.log('密码输入框:', loginPassword);
            const username = loginUsername?.value;
            const password = loginPassword?.value;
            console.log('用户名输入:', username);
            console.log('密码输入:', password);
            if (window.isCloudReady) {
                getCloudData().then(data => {
                    console.log('云存储中的用户:', data.users);
                }).catch(error => {
                    console.error('获取用户数据失败:', error);
                });
            } else {
                console.warn('云存储未初始化');
            }
        };
        
        // 调试注册功能
        window.debugRegister = function() {
            console.log('🔍 调试注册功能:');
            const registerBtn = document.getElementById('doRegisterBtn');
            const registerUsername = document.getElementById('registerUsername');
            const registerPassword = document.getElementById('registerPassword');
            const registerConfirmPassword = document.getElementById('registerConfirmPassword');
            console.log('注册按钮:', registerBtn);
            console.log('用户名输入框:', registerUsername);
            console.log('密码输入框:', registerPassword);
            console.log('确认密码输入框:', registerConfirmPassword);
            const username = registerUsername?.value;
            const password = registerPassword?.value;
            const confirmPassword = registerConfirmPassword?.value;
            console.log('用户名输入:', username);
            console.log('密码输入:', password);
            console.log('确认密码:', confirmPassword);
            if (window.isCloudReady) {
                getCloudData().then(data => {
                    console.log('现有用户:', data.users);
                }).catch(error => {
                    console.error('获取用户数据失败:', error);
                });
            } else {
                console.warn('云存储未初始化');
            }
        };
        
        // 调试云存储
        window.debugCloud = function() {
            console.log('🔍 调试云存储:');
            if (!window.isCloudReady) {
                console.log('云存储未初始化，尝试初始化...');
                initCloudBase().then(success => {
                    console.log('云存储初始化结果:', success);
                    if (success) {
                        window.debugCloud();
                    }
                }).catch(error => {
                    console.error('云存储初始化失败:', error);
                });
            } else {
                getCloudData().then(data => {
                    console.log('云存储数据:', data);
                    console.log(`用户数量: ${data.users.length}`);
                    console.log(`资源数量: ${data.resources.length}`);
                    if (data.users.length > 0) {
                        console.log('用户名列表:', data.users.map(u => u.username));
                    }
                }).catch(error => {
                    console.error('获取云存储数据失败:', error);
                });
            }
        };
        
        console.log('✅ 调试功能已直接暴露到全局作用域');
        console.log('🔍 可用的调试方法:');
        console.log('- window.showLoginModal() - 显示登录弹窗');
        console.log('- window.debugLogin() - 调试登录功能');
        console.log('- window.debugRegister() - 调试注册功能');
        console.log('- window.debugCloud() - 调试云存储');

        // 直接暴露调试功能到全局作用域
        window.testCloudStorage = async function() {
            console.log('📋 测试云存储连接...');
            await initCloudBase();
            console.log('云存储状态:', isCloudReady);
            return isCloudReady;
        };

        window.testGetCloudData = async function() {
            console.log('📋 测试获取云数据...');
            const data = await getCloudData();
            console.log('获取到的数据:', data);
            return data;
        };

        window.testLoginButton = function() {
            console.log('📋 检查登录按钮...');
            const loginBtn = document.getElementById('doLoginBtn');
            console.log('登录按钮:', loginBtn);
            console.log('登录按钮事件监听', loginBtn?.addEventListener);
            return loginBtn;
        };

        window.testRegisterButton = function() {
            console.log('📋 检查注册按钮...');
            const registerBtn = document.getElementById('doRegisterBtn');
            console.log('注册按钮:', registerBtn);
            console.log('注册按钮事件监听', registerBtn?.addEventListener);
            return registerBtn;
        };

        window.testInputs = function() {
            console.log('📋 检查输入框...');
            const loginUsername = document.getElementById('loginUsername');
            const loginPassword = document.getElementById('loginPassword');
            const registerUsername = document.getElementById('registerUsername');
            const registerPassword = document.getElementById('registerPassword');
            const registerConfirmPassword = document.getElementById('registerConfirmPassword');
            
            console.log('登录用户名:', loginUsername);
            console.log('登录密码:', loginPassword);
            console.log('注册用户名:', registerUsername);
            console.log('注册密码:', registerPassword);
            console.log('确认密码:', registerConfirmPassword);
            
            return {
                loginUsername,
                loginPassword,
                registerUsername,
                registerPassword,
                registerConfirmPassword
            };
        };

        window.runFullDebug = async function() {
            console.log('🚀 开始完整调试流程');
            
            // 检查 DOM 元素
            const elements = window.testInputs();
            const loginBtn = window.testLoginButton();
            const registerBtn = window.testRegisterButton();
            
            // 测试云存储
            const cloudSuccess = await window.testCloudStorage();
            if (cloudSuccess) {
                const data = await window.testGetCloudData();
                console.log('📊 云数据详情:');
                console.log(`👥 用户数: ${data.users.length}`);
                console.log(`📚 资源数: ${data.resources.length}`);
                if (data.users.length > 0) {
                    console.log(`👤 用户名列表: ${data.users.map(u => u.username).join(', ')}`);
                }
            }
            
            console.log('🎉 调试完成');
            return {
                elements,
                loginBtn,
                registerBtn,
                cloudSuccess
            };
        };

        // 显示登录弹窗函数
        function showLoginModal() {
            console.log('📺 尝试直接显示登录弹窗');
            const authModal = document.getElementById('authModal');
            if (authModal) {
                authModal.classList.remove('hidden');
                console.log('✅ 登录弹窗已显示');
            } else {
                console.error('❌ 无法找到登录弹窗');
            }
        }
        window.showLoginModal = showLoginModal;

        // 内联调试函数（临时添加）
        window.debugLogin = function() {
            console.log('🔍 调试登录功能:');
            
            // 检查 DOM 元素
            const loginBtn = document.getElementById('doLoginBtn');
            const loginUsername = document.getElementById('loginUsername');
            const loginPassword = document.getElementById('loginPassword');
            
            console.log('登录按钮:', loginBtn);
            console.log('用户名输入框:', loginUsername);
            console.log('密码输入框:', loginPassword);
            
            // 检查输入值
            const username = loginUsername?.value;
            const password = loginPassword?.value;
            
            console.log('用户名输入:', username);
            console.log('密码输入:', password);
            
            // 尝试获取用户数据
            if (isCloudReady) {
                getCloudData().then(data => {
                    console.log('云存储中的用户:', data.users);
                    const users = data.users;
                    if (users.length > 0) {
                        console.log('第一个用户:', users[0]);
                    }
                }).catch(error => {
                    console.error('获取用户数据失败:', error);
                });
            } else {
                console.warn('云存储未初始化');
            }
        };

        window.debugRegister = function() {
            console.log('🔍 调试注册功能:');
            
            const registerBtn = document.getElementById('doRegisterBtn');
            const registerUsername = document.getElementById('registerUsername');
            const registerPassword = document.getElementById('registerPassword');
            const registerConfirmPassword = document.getElementById('registerConfirmPassword');
            
            console.log('注册按钮:', registerBtn);
            console.log('用户名输入框:', registerUsername);
            console.log('密码输入框:', registerPassword);
            console.log('确认密码输入框:', registerConfirmPassword);
            
            const username = registerUsername?.value;
            const password = registerPassword?.value;
            const confirmPassword = registerConfirmPassword?.value;
            
            console.log('用户名输入:', username);
            console.log('密码输入:', password);
            console.log('确认密码:', confirmPassword);
            
            if (isCloudReady) {
                getCloudData().then(data => {
                    console.log('现有用户:', data.users);
                }).catch(error => {
                    console.error('获取用户数据失败:', error);
                });
            } else {
                console.warn('云存储未初始化');
            }
        };

        window.debugCloud = function() {
            console.log('🔍 调试云存储:');
            
            // 测试连接
            if (!isCloudReady) {
                console.log('云存储未初始化，尝试初始化...');
                initCloudBase().then(success => {
                    console.log('云存储初始化结果:', success);
                    if (success) {
                        window.debugCloud(); // 重新调试
                    }
                }).catch(error => {
                    console.error('云存储初始化失败:', error);
                });
            } else {
                // 已初始化，获取数据
                getCloudData().then(data => {
                    console.log('云存储数据:', data);
                    console.log(`用户数量: ${data.users.length}`);
                    console.log(`资源数量: ${data.resources.length}`);
                    if (data.users.length > 0) {
                        console.log('用户名列表:', data.users.map(u => u.username));
                    }
                }).catch(error => {
                    console.error('获取云存储数据失败:', error);
                });
            }
        };

        console.log('✅ 调试功能已直接暴露到全局作用域');
        console.log('🔍 可用的调试方法:');
        console.log('- runFullDebug() - 完整调试');
        console.log('- testCloudStorage() - 测试云存储');
        console.log('- testGetCloudData() - 测试获取云数据');
        console.log('- testLoginButton() - 检查登录按钮');
        console.log('- testRegisterButton() - 检查注册按钮');
        console.log('- testInputs() - 检查输入框');
        console.log('');
        console.log('ℹ️ 当前系统已完全切换到本地存储模式');
        console.log('💡 所有数据保存在浏览器 localStorage 中');
        console.log('💡 在控制台输入 showLocalUsers() 查看用户列表');
    </script>
</body>
</html>
